# Reglas de Alertas para Sistema de Gimnasio v6
# Prometheus Alert Rules

groups:
  # ============================================================================
  # ALERTAS DE INFRAESTRUCTURA
  # ============================================================================
  - name: infrastructure
    rules:
      # CPU Usage
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Alto uso de CPU en {{ $labels.instance }}"
          description: "El uso de CPU está por encima del 80% durante más de 5 minutos en {{ $labels.instance }}"

      # Memory Usage
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Alto uso de memoria en {{ $labels.instance }}"
          description: "El uso de memoria está por encima del 85% durante más de 5 minutos en {{ $labels.instance }}"

      # Disk Usage
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Alto uso de disco en {{ $labels.instance }}"
          description: "El uso de disco está por encima del 85% en {{ $labels.mountpoint }} en {{ $labels.instance }}"

      # Container Health
      - alert: ContainerDown
        expr: absent(container_last_seen)
        for: 1m
        labels:
          severity: critical
          service: infrastructure
        annotations:
          summary: "Contenedor caído: {{ $labels.name }}"
          description: "El contenedor {{ $labels.name }} no se ha visto en más de 1 minuto"

  # ============================================================================
  # ALERTAS DE BASE DE DATOS
  # ============================================================================
  - name: database
    rules:
      # PostgreSQL Connection
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 30s
        labels:
          severity: critical
          service: database
        annotations:
          summary: "PostgreSQL no está disponible"
          description: "No se puede conectar a PostgreSQL en {{ $labels.instance }}"

      # PostgreSQL Active Connections
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 2m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Muchas conexiones activas en PostgreSQL"
          description: "Hay más de 80 conexiones activas en PostgreSQL en {{ $labels.instance }}"

      # PostgreSQL Slow Queries
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_activity_max_tx_duration{datname!=""}[5m]) > 30
        for: 1m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Consultas lentas en PostgreSQL"
          description: "Hay consultas que tardan más de 30 segundos en PostgreSQL en {{ $labels.instance }}"

      # PostgreSQL Deadlocks
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks[5m]) > 0
        for: 1m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Deadlocks detectados en PostgreSQL"
          description: "Se han detectado deadlocks en PostgreSQL en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE REDIS
  # ============================================================================
  - name: redis
    rules:
      # Redis Connection
      - alert: RedisDown
        expr: redis_up == 0
        for: 30s
        labels:
          severity: critical
          service: cache
        annotations:
          summary: "Redis no está disponible"
          description: "No se puede conectar a Redis en {{ $labels.instance }}"

      # Redis Memory Usage
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
        for: 2m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Alto uso de memoria en Redis"
          description: "El uso de memoria en Redis está por encima del 80% en {{ $labels.instance }}"

      # Redis Connected Clients
      - alert: RedisHighConnections
        expr: redis_connected_clients > 100
        for: 2m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Muchos clientes conectados a Redis"
          description: "Hay más de 100 clientes conectados a Redis en {{ $labels.instance }}"

      # Redis Keyspace Hits
      - alert: RedisLowHitRate
        expr: rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) * 100 < 80
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Baja tasa de aciertos en Redis"
          description: "La tasa de aciertos en Redis está por debajo del 80% en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE BACKEND
  # ============================================================================
  - name: backend
    rules:
      # Backend Health
      - alert: BackendDown
        expr: up{job="gym-backend"} == 0
        for: 30s
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "Backend no está disponible"
          description: "El backend FastAPI no está respondiendo en {{ $labels.instance }}"

      # Backend Response Time
      - alert: BackendSlowResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "Respuestas lentas del backend"
          description: "El 95% de las respuestas del backend tardan más de 2 segundos en {{ $labels.instance }}"

      # Backend Error Rate
      - alert: BackendHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "Alta tasa de errores en el backend"
          description: "Más del 5% de las peticiones al backend resultan en errores 5xx en {{ $labels.instance }}"

      # Backend Request Rate
      - alert: BackendHighRequestRate
        expr: rate(http_requests_total[5m]) > 1000
        for: 2m
        labels:
          severity: info
          service: backend
        annotations:
          summary: "Alta tasa de peticiones al backend"
          description: "Más de 1000 peticiones por minuto al backend en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE NGINX
  # ============================================================================
  - name: nginx
    rules:
      # Nginx Status
      - alert: NginxDown
        expr: nginx_up == 0
        for: 30s
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: "Nginx no está disponible"
          description: "Nginx no está respondiendo en {{ $labels.instance }}"

      # Nginx Error Rate
      - alert: NginxHighErrorRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) / rate(nginx_http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: "Alta tasa de errores en Nginx"
          description: "Más del 5% de las peticiones a Nginx resultan en errores 5xx en {{ $labels.instance }}"

      # Nginx Request Rate
      - alert: NginxHighRequestRate
        expr: rate(nginx_http_requests_total[5m]) > 2000
        for: 2m
        labels:
          severity: info
          service: nginx
        annotations:
          summary: "Alta tasa de peticiones a Nginx"
          description: "Más de 2000 peticiones por minuto a Nginx en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE BACKUP
  # ============================================================================
  - name: backup
    rules:
      # Backup Service Health
      - alert: BackupServiceDown
        expr: up{job="backup"} == 0
        for: 1m
        labels:
          severity: critical
          service: backup
        annotations:
          summary: "Servicio de backup no está disponible"
          description: "El servicio de backup no está respondiendo en {{ $labels.instance }}"

      # Backup Last Success
      - alert: BackupFailed
        expr: time() - backup_last_success_timestamp_seconds > 86400
        for: 1h
        labels:
          severity: critical
          service: backup
        annotations:
          summary: "Backup falló en las últimas 24 horas"
          description: "No se ha completado un backup exitoso en las últimas 24 horas en {{ $labels.instance }}"

      # Backup Duration
      - alert: BackupTooSlow
        expr: backup_duration_seconds > 3600
        for: 1m
        labels:
          severity: warning
          service: backup
        annotations:
          summary: "Backup muy lento"
          description: "El último backup tardó más de 1 hora en completarse en {{ $labels.instance }}"

      # Backup Size
      - alert: BackupSizeTooLarge
        expr: backup_size_bytes > 1073741824
        for: 1m
        labels:
          severity: warning
          service: backup
        annotations:
          summary: "Backup muy grande"
          description: "El último backup es mayor a 1GB en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE SEGURIDAD
  # ============================================================================
  - name: security
    rules:
      # Failed Login Attempts
      - alert: HighFailedLogins
        expr: rate(auth_failed_login_attempts_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Muchos intentos de login fallidos"
          description: "Más de 10 intentos de login fallidos por minuto en {{ $labels.instance }}"

      # Unauthorized Access
      - alert: UnauthorizedAccess
        expr: rate(http_requests_total{status="401"}[5m]) > 5
        for: 2m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Accesos no autorizados detectados"
          description: "Más de 5 peticiones 401 por minuto en {{ $labels.instance }}"

      # Rate Limiting
      - alert: RateLimitExceeded
        expr: rate(rate_limit_exceeded_total[5m]) > 0
        for: 1m
        labels:
          severity: info
          service: security
        annotations:
          summary: "Límites de tasa excedidos"
          description: "Se han excedido los límites de tasa en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE FRONTEND
  # ============================================================================
  - name: frontend
    rules:
      # Frontend Health
      - alert: FrontendDown
        expr: up{job="frontend"} == 0
        for: 30s
        labels:
          severity: critical
          service: frontend
        annotations:
          summary: "Frontend no está disponible"
          description: "El frontend Next.js no está respondiendo en {{ $labels.instance }}"

      # Frontend Build Status
      - alert: FrontendBuildFailed
        expr: frontend_build_status == 0
        for: 5m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "Build del frontend falló"
          description: "El último build del frontend falló en {{ $labels.instance }}"

  # ============================================================================
  # ALERTAS DE SISTEMA
  # ============================================================================
  - name: system
    rules:
      # System Load
      - alert: HighSystemLoad
        expr: node_load1 > 5
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Alta carga del sistema"
          description: "La carga del sistema está por encima de 5 en {{ $labels.instance }}"

      # Network Errors
      - alert: NetworkErrors
        expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Errores de red detectados"
          description: "Se han detectado errores de red en {{ $labels.instance }}"

      # Disk I/O
      - alert: HighDiskIO
        expr: rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Alto I/O de disco"
          description: "El I/O de disco está por encima del 80% en {{ $labels.instance }}" 