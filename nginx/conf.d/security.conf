# =============================================================================
# CONFIGURACIÓN DE SEGURIDAD PARA NGINX
# Sistema de Gestión de Gimnasio v6.0
# =============================================================================

# Headers de seguridad
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'self';" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Ocultar versión de Nginx (definido en nginx.conf)

# Limitar tamaño de request
# client_max_body_size 10M;
# client_body_buffer_size 128k;
# client_header_buffer_size 1k;
# large_client_header_buffers 4 4k;

# Timeouts de seguridad
# client_body_timeout 60s;
# client_header_timeout 60s;
# send_timeout 60s;
# keepalive_timeout 65s;

# Configuración de rate limiting
# limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
# limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;

# Configuración de conexiones
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn conn_limit_per_ip 10;

# Configuración de SSL/TLS
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
ssl_prefer_server_ciphers off;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# Configuración de OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# Configuración de gzip con seguridad
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    image/svg+xml;

# Configuración de logs de seguridad
log_format security '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '"$http_x_forwarded_for" "$request_time" '
                    '"$upstream_response_time" "$upstream_addr"';

# Configuración de error pages
error_page 400 401 403 404 405 408 413 414 415 429 500 502 503 504 /error.html;

# Configuración de mantenimiento
location = /maintenance.html {
    root /usr/share/nginx/html;
    internal;
}

# Configuración de health check
location = /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# Bloque server para las directivas if
server {
    # Limitar métodos HTTP permitidos
    if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
        return 405;
    }

    # Bloquear user agents maliciosos
    if ($http_user_agent ~* (bot|crawler|spider|scraper|curl|wget|python|java|php|perl|ruby|bash|shell|cmd|powershell)) {
        return 403;
    }

    # Bloquear requests con headers sospechosos
    if ($http_x_forwarded_for ~* (127\.0\.0\.1|localhost|0\.0\.0\.0)) {
        return 403;
    }

    # Bloquear requests con referrers maliciosos
    if ($http_referer ~* (eval|base64|javascript|vbscript|onload|onerror|onclick)) {
        return 403;
    }

    # Bloquear archivos sensibles
    location ~* \.(env|log|sql|bak|backup|old|tmp|temp|swp|swo)$ {
        deny all;
        return 404;
    }

    # Bloquear acceso a directorios ocultos
    location ~ /\. {
        deny all;
        return 404;
    }

    # Bloquear acceso a archivos de configuración
    location ~* \.(conf|config|ini|cfg|yml|yaml|json)$ {
        deny all;
        return 404;
    }

    # Configuración de cache de seguridad
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
    }
} 