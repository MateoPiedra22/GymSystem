# =============================================================================
# CONFIGURACIÓN PRINCIPAL DE NGINX
# Sistema de Gestión de Gimnasio v6.0
# =============================================================================

# Usuario y workers
user nginx;
worker_processes auto;
worker_rlimit_nofile 65535;

# PID y error log
pid /var/run/nginx.pid;
error_log /var/log/nginx/error.log warn;

# Eventos optimizados
events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
    accept_mutex off;
    # Configuración adicional para rendimiento
}

# Configuración HTTP principal
http {
    # ==========================================================================
    # CONFIGURACIÓN BÁSICA
    # ==========================================================================
    
    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Charset
    charset utf-8;
    
    # Server tokens (ocultar versión de Nginx)
    server_tokens off;
    
    # ==========================================================================
    # CONFIGURACIÓN DE RATE LIMITING
    # ==========================================================================
    
    # Definir zonas de rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=frontend:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=login:10m rate=1r/m;
    
    # ==========================================================================
    # CONFIGURACIÓN DE UPSTREAM
    # ==========================================================================
    
    upstream backend {
        server backend:8000 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    
    upstream frontend {
        server frontend:3000 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    
    # ==========================================================================
    # INCLUIR CONFIGURACIONES ESPECÍFICAS
    # ==========================================================================
    
    # Configuraciones de sitios específicos
    include /etc/nginx/conf.d/*.conf;
    
    # ==========================================================================
    # SERVIDOR POR DEFECTO (FALLBACK)
    # ==========================================================================
    
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        
        # Rechazar todas las peticiones no configuradas
        location / {
            return 444;
        }
        
        # Health check básico para Nginx
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
} 